{{
  config(
    materialized = 'table',
    labels = {'type': 'funnel_data', 'contains_pie': 'no', 'category':'staging'}  
  )
}}

with date_range as (
select
    '20200101' as start_date,
    format_date('%Y%m%d',date_sub(current_date(), interval 1 day)) as end_date 
    ) 

select 
  distinct
  Date,
  b.Country_ as country,
  Data_Source_type,
  Data_Source_id,
  Currency,
  Cost,
  Impressions,
  Clicks,
  Campaign,
  Media_type,
  Data_Source,
  Data_Source_name,
  Funnel_Account_name,
  Day_of_week,
  Month,
  Month_number,
  Week,
  Week_number,
  Week_number_ISO,
  Year,
  Ad__AdWords,
  Ad_Account_Customer_ID__AdWords,
  Ad_Account_Name__AdWords,
  Ad_Account_Timezone__AdWords,
  Ad_Group_ID__AdWords,
  Ad_Group_Name__AdWords,
  Ad_Group_Type__AdWords,
  Ad_ID__AdWords,
  Ad_Name__AdWords,
  Ad_Type__AdWords,
  Campaign__AdWords,
  Campaign_ID__AdWords,
  Campaign_Type__AdWords,
  Clicks__AdWords,
  Cost__AdWords,
  Engagements__AdWords,
  Impressions__AdWords,
  Interactions__AdWords,
  Video_views__AdWords,
  Views__AdWords,
  Advertiser_Country__Awin,
  Advertiser_ID__Awin,
  Advertiser_Name__Awin,
  Publisher_Name__Awin,
  Publisher_ID__Awin,
  Confirmed_Amount__Awin,
  Total_Amount__Awin,
  Clicks__Awin,
  Impressions__Awin,
  Total_Commission__Awin,
  Approved_transaction_amount__Awin,
  Approved_transaction_commission__Awin,
  Transaction_Commission__Awin,
  Transaction_Amount__Awin,
  Clicks__Criteo,
  Cost__Criteo,
  Impressions__Criteo,
  Order_Value__Criteo,
  Sales__Criteo,
  Sales_Post_Click_1d__Criteo,
  Sales_Post_Click_7d__Criteo,
  Ad_set__Criteo,
  Ad_set_ID__Criteo,
  Advertiser__Criteo,
  Advertiser_ID__Criteo,
  Category_ID__Criteo,
  Category_Name__Criteo,
  Device__Criteo,
  Ad_Account_ID__Facebook_Ads,
  Ad_ID__Facebook_Ads,
  Ad_Name__Facebook_Ads,
  Ad_Set_ID__Facebook_Ads,
  Ad_Set_Name__Facebook_Ads,
  Campaign_ID__Facebook_Ads,
  Campaign_Name__Facebook_Ads,
  Campaign_Objective__Facebook_Ads,
  Clicks_all__Facebook_Ads,
  Amount_Spent__Facebook_Ads,
  Impressions__Facebook_Ads,
  Spend__Snapchat,
  Shares__Snapchat,
  Saves__Snapchat,
  Leads__Snapchat,
  Impressions__Snapchat,
  Story_Opens__Snapchat,
  Story_completes__Snapchat,
  Swipes__Snapchat,
  Video_Views__Snapchat,
  Account_ID__Snapchat,
  Ad_account_name__Snapchat,
  Ad_ID__Snapchat,
  Ad_Name__Snapchat,
  Ad_Type__Snapchat,
  Campaign_ID__Snapchat,
  Campaign_Name__Snapchat,
  Squad_ID__Snapchat,
  Squad_Name__Snapchat,
  Ad_ID__TikTok,
  Ad_name__TikTok,
  Adgroup_ID__TikTok,
  Adgroup_name__TikTok,
  Advertiser_name__TikTok,
  Advertiser_ID__TikTok,
  Campaign_ID__TikTok,
  Campaign_name__TikTok,
  Clicks__TikTok,
  Conversions__TikTok,
  Impressions__TikTok,
  Total_cost__TikTok,
  Likes__TikTok,
  Paid_comments__TikTok,
  Paid_Follows__TikTok,
  Campaign_Cost__RTB_House,
  Campaign_ID__RTB_House,
  Device_type__RTB_House,
  Sub_Campaign__RTB_House,
  Impressions__RTB_House,
  Attr_PC_Conversion_Value__RTB_House,
  PC_Conversion_Count__RTB_House,
  PC_Conversion_Value__RTB_House,
  Clicks__RTB_House,
  PV_Conversion_Count__RTB_House,
  PV_Conversion_Value__RTB_House
from {{ source('funnel', 'funnel_data_*') }} a ,
date_range
left join {{ source('funnel', 'funnel_account_orga') }} b 
on a.Data_Source_name = b.NAME
 where _table_suffix between start_date and end_date

